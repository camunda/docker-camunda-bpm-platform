language: generic

os: linux

services:
  - docker

env:
  - DISTRO=tomcat
  - DISTRO=wildfly
  - DISTRO=run

jobs:
  include:  # do not build EE for PRs from forks (Nexus EE credentials are not available)
    - if: TRAVIS_PULL_REQUEST_SLUG IS blank TRAVIS_PULL_REQUEST_SLUG = "camunda/docker-camunda-bpm-platform"
      env: DISTRO=tomkitty EE=true
    - if: env(TRAVIS_PULL_REQUEST_SLUG) IS blank #OR env(TRAVIS_PULL_REQUEST_SLUG) = "camunda/docker-camunda-bpm-platform"
      env: DISTRO=tomcat EE=true
    - if: env(TRAVIS_PULL_REQUEST_SLUG) IS blank #OR env(TRAVIS_PULL_REQUEST_SLUG) = "camunda/docker-camunda-bpm-platform"
      env: DISTRO=wildfly EE=true
    - if: env(TRAVIS_PULL_REQUEST_SLUG) IS blank #OR env(TRAVIS_PULL_REQUEST_SLUG) = "camunda/docker-camunda-bpm-platform"
      env: DISTRO=run EE=true

script:
  - echo y2"${TRAVIS_PULL_REQUEST_SLUG}"
  - echo z2"${TRAVIS_REPO_SLUG}"
  - echo u1"${NEXUS_USER}" p1"${NEXUS_PASS}"
  - |
    docker build .                              \
      -t camunda/camunda-bpm-platform:${DISTRO} \
      --build-arg DISTRO=${DISTRO}              \
      --build-arg EE=${EE}                      \
      --build-arg USER=${NEXUS_USER}            \
      --build-arg PASSWORD=${NEXUS_PASS}
  - ./test/test.sh
  - ./release.sh
