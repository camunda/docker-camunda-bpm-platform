language: generic

os: linux

services:
  - docker

env:
  - DISTRO=tomcat
  - DISTRO=wildfly
  - DISTRO=run

jobs:
  include:  # do not build EE for PRs from forks (Nexus EE credentials are not available)
    - if: env(TRAVIS_PULL_REQUEST_SLUG) IN ("camunda/docker-camunda-bpm-platform", "")
      env: DISTRO=tomcat EE=true
    - if: env(TRAVIS_PULL_REQUEST_SLUG) IN ("camunda/docker-camunda-bpm-platform", "")
      env: DISTRO=wildfly EE=true
    - if: env(TRAVIS_PULL_REQUEST_SLUG) IN ("camunda/docker-camunda-bpm-platform", "")
      env: DISTRO=run EE=true

script:
  - echo y"${TRAVIS_PULL_REQUEST_SLUG}"
  - echo z"${TRAVIS_REPO_SLUG}"
  - echo u1"${NEXUS_USER}" p1"${NEXUS_PASS}"
  - |
    docker build .                              \
      -t camunda/camunda-bpm-platform:${DISTRO} \
      --build-arg DISTRO=${DISTRO}              \
      --build-arg EE=${EE}                      \
      --build-arg USER=${NEXUS_USER}            \
      --build-arg PASSWORD=${NEXUS_PASS}
  - ./test/test.sh
  - ./release.sh

# Only build EE if Nexus credentials are provided (i.e. when CI is triggered by project maintainers not PRs).
# if: env(NEXUS_USER) != "" AND env(NEXUS_PASS) != ""
